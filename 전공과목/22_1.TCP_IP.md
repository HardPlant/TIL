# TCP/IP

## 물리 계층

## 데이터 링크 계층

노드-노드 통신

### 서비스

* 프레임 짜기 (데이터그램을 프레임에서 캡슐화)

* 흐름 제어 (매우 중요함)

* 오류 제어 (전기 신호는 오류에 취약함)

* 혼잡 제어 (사용하지 않음)

## 네트워크 계층

* 라우팅

* 포워딩

라우팅 테이블, 포워딩 테이블

## IPv4 주소

* 5개의 클래스

A: 0 + 7bit (네트워크) + 24bit(호스트)
B: 10 + 14bit (네트워크) + 16bit(호스트)
C: 110 + 21bit (네트워크 주소) + 8bit (호스트)
D: 1110
E: 1111 (Reserved)

* 서브네팅

클래스 A,B ==> 여러 개의 서브넷으로 분리
각 네트워크 당 2^8-2개 호스트 사용

B클래스에서 호스트 주소 8비트를 서브네팅하는 경우

(네트워크 마스크)255.255.0.0 ==> 255.255.255.0
( (서브네트워크 마스크) 255.255.255.0) * 2^8)
2^16개 네트워크, 2^16-2개 호스트
==> 각 네트워크 당 2^8-2개 호스트를 가진 2^8개의 서브네트워크로 나눔

* 슈퍼네팅

* CIDR (Classless Inter-domain Routing)

위 클래스의 개념을 무시하고, 접두사를 가변적으로 이동가능하게 함
ISP가 client가 필요한 양만큼 잘라서 공급 가능

* VLSM (Various len 서브넷 마스크)

서로 다른 크기의 서브넷을 지원하기 위한 구조이다.
네트워크를 나열하고, 가장 많은 호스트부터 차례로 가져나간다.

netA : 14 host
netB : 28 host
netC : 2 host
netD : 7 host
netE : 28 host

그리고 204.15.5.0 네트워크를 할당받았다면

netB : 204.15.5.0/27 (0~31)
netE : 204.15.5.32/27 (0~31)
netA : 204.15.5.64/28 (0~15)
netD : 204.15.5.80/28 (0~15)
netC : 204.15.5.96/31 (0~2)

* 특수 주소

this : 0.0.0.0/32 - 자신의 주소를 모를 때
broadcast : 255.255.255.255/32
loopback : 127.0.0.0/8 - 호스트 내부에만 남음 (11111111.00000000.00000000.00000000) ==> 127.0.0.0~127.255.255.255
private
    10.0.0.0/8 (10.0.0.0~10.255.255.255)
    172.16.0.0/12 (11111111.11110000.00000000.00000000) ==> 172.16.0.0~172.31.255.255
    192.168.0.0/16 (11111111.11111111.00000000.00000000) ==> 192.168.0.0~192.168.255.255
    169.254.0.0/16 (169.254.0.0~169.254.255.255)
multicast

## 네트워크 계층 프로토콜

### IP

Best-effort delivery service
신뢰성이 중요하다면 TCP같은 신뢰성 보장 프로토콜과 함꼐 사용해야 한다.

TCP/UDP, ICMP, IGMP(Internet Group Management)

* 패킷

20~65535 bytes (2^16), 4MB
20~60Byte{Header} + {Payload}

4{VER} 4{HLEN} 8{Service Type} 16{Total Length}
16{Identification} 3{Flags} 13{Fragmentation offset}
8{Time to live} 8{Protocol} 16{Header Chhecksum}
32{SrcIP}
32{DestIP}
0~40{Options + padding}

### 논리주소와 물리주소의 변환

* ARP(Address Resolution Protocol)

    IP ==> MAC

    물리 계층 브로드캐스트를 통해 모든 호스트에게 패킷을 전송한다.
    응답을 받은 호스트/라우터는 수신 IP주소가 자신의 IP주소면 ARP 응답 메시지를 전송한다.

* ARP 메시지 종류

ARP Request

ARP Response (호스트가 라우터를 넘어 다른 네트워크에 있으면 라우터가 대신 응답 전송)

* ICMPv4 (Internet Control Message Protocol)

    호스트가 라우터/다른 호스트가 동작하고 있는지 알 필요가 있을때
    다른 호스트나 라우터로부터 정보를 얻을 필요가 있을 떄

  * 오류보고 메시지 : 03 (Dest unreachable), 04(Source quench), 05(Redirection), 11(Time Exceed), 12(Parameter Problem)

    8{Type} 8{Code} 16{Checksum}
    32{Rest of the header}
    data

    라우터/호스트가 IP 패킷 처리 중 오류 발생시

  * 질의 메시지 : 08 00 (Echo request / Reply), 13 14 (Timestamp request/reply)

    8{Type} 8{Code} 16{Checksum}
    16{Identifier} 16{Sequence number}

    호스트/네트워크->라우터나 다른 호스로부터 정보 획득을 위해 사용

* ICMP 오류 보고 메시지

    보고만 수행함
    오류 메시지는 127.0.0.0, 0.0.0.0등 특수한 주소를 가진 데이터그램, 멀티캐스트 주소 데이터그램에 생성되지 않는다.
    ICMP 오류 메시지 데이터그램의 응답으로 오류 메시지를 다시 생성해서 응답하지 않는다.
    ICMP 오류 메시지의 첫 번째가 아닌 블록을 위해 ICMP 오류 메시지를 다시 생성하지 않는다.

  * 03 : Dest Unreachable

    문제를 정의하기 위해 0~15까지의 추가 코드를 사용한다.

  * 04 : Source Quench(근원지 억제)

    송신지에서 충돌이 일어나 데이터그램이 폐기됨을 알린다.
    혼잡제어를 추가한다.

  * 05 : Redirection

    메시지 안에 디폴트 라우터의 IP 주소가 포함된다.

  * 11 : Time Exceed

    TTL이 0이 되면 시간경과 메시지를 src에 발송한다. (코드 0)

  * 12 : Parameter Problem

* ICMP 질의 메시지

    ping, traceroute 에서 Echo Request/Response를 확인할 수 있다.

## IPv6

32비트 ==> 128비트

보안문제,QoS(전송률/에러율 관련 서비스 품질) 보장, 무선 인터넷 지원 등

### 특징

* 확장된 주소 공간 : NAT 사용 불필요, 유니캐스트/애니캐스트/멀티캐스트 주소형태 있음

* 새로운 헤더 포맷

    일부 헤더 필드 삭제, 확장 헤더 도입
    헤더를 고정 길이로 변경
    패킷 단편화 필드 삭제 (경로 MTU 탐색기능 추가)
    체크섬 필드 삭제 (데이터링크 계층에서 checksum 계산)

* 향상된 서비스의 지원

    생성된 트래픽을 실시간 트래픽/비실시간 트래픽으로 구분
    헤더 내에 Flow Label 필드를 통해 트래픽 분류 가능

* 보안 기능

    인증 절차, 데이터 무결성 보호, 메시지 발신지 확인 기능 제공
    종단간 암호화로 패킷 변조 방지
    (IPSec 자체 지원)

### 주소

* 주소 공간

    n+m+q = 128bit
    n{Global routing prefix}, m{subnet identifier}, q{interface identifier}

  * 유니캐스트

    단일 인터페이스를 정의한다. (특정한 컴퓨터에 전달)

  * 애니캐스트

    단일 주소를 공유하는 컴퓨터들의 집합 (가장 가까이 있는 애니캐스트 그룹 구성원에게 전달)

  * 멀티캐스트

    컴퓨터의 그룹 (애니캐스트 => 그룹 중 하나의 컴퓨터에 전송, 멀티캐스트 => 각 컴퓨터가 복사본 수신)
    브로드캐스트 => 멀티캐스트의 특수한 경우

### IPv4 ==> IPv6

변환 기간 동안 호스트는 IPv4, IPv6 2개의 주소를 사용함

* 전략

  * 이중 스택

    주소 2개를 동시에 사용함

  * 터널링

    IPv4만 사용하는 라우터가 중간에 있을 때
    시작 라우터가 IPv4 패킷을 새로 만들어 IPv6 패킷을 페이로드로 넣어 캡슐화한다.
    끝 라우터는 패킷을 받아 역캡슐화한다.

  * 헤더 변환

    수신자가 IPv4 라우터 하에 있을때, 라우터는 IPv6 패킷을 IPv4 패킷으로 변경해 전달한다.