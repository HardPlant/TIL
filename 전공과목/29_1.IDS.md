# IDS

* 외부침입에 대한 정보 수집, 분석해 침입활동을을 탐지, 이에 대응하도록 보안 담당자에게 통보

* 보안정책에 따라 탐지 및 대응ㅊ책 설정

* 시스템 및 네트워크의 감사기록으로부터 불필요한 정보 제거

* 데이터베이스에 있는 정보와 비교해 침입 탐지

## 특징

* 내/외부망의 접속점에 위치 : 방화벽의 부족한 부분 보강

* 경고음 발생 / ALC값 변경시키는 재설정 파일 전송

* 공격의 증거를 찾기 위한 네트워크 트래픽분서 역할 ==> 시스템의 침해여부를 보기 위해 액세스 로그들을 조사해 파일 분석 ==> 허니팟 개념으로 확장

### 실행단계

* 데이터 수집 단계

* 데이터 가공 및 축약 단계 : 읽어보지 않을 데이터는 모으지도 마라

* 침입분석 단계 : 비정상 행위 탐지 기법, 오용 탐지 기법

* 보고 및 대응 단계

## IDS의 종류

* 탐지방법에 따라

  * 규칙 기반 침입탐지 : False-positive가 적음

    전문가 시스템 : if-then-rule
    상태전이 모델 : 시스템의 상태 변화를 상태전이도로 표현 -> 시스템의 상태 변화 추적
    패턴 매칭 : 알려진 공격 패턴들을 시나리오 형태로 데이터베이스에 저장한 후 판단

  * 통계적 변형 탐지

    침입 이외의 시스템 운용상의 문제점도 발견할 수 있다.

    통계적 분석 방법 : 이전 정보 기반
    예측 가능한 패턴 생성 방법 : 일정기간 동안 정상적인 행위 사건을 패턴화해, 현재 사건들 간 상호관게를 순서로 비교
    신경망 모델 : Adopt-learn 기술을 사용

* 대응방법에 따라

  * 수동적 대응방법

  * 능동적 대응방법 : 침입에 대해 빨리 실행할 수 있는 행동 취함, 오경보 발생 가능

* 수집된 데이터에 따라

  * 네트워크 기반 : 무차별 모드(promisc-)에서 동작하는 NIC에 설치되어 있음

    네트워크 세그먼트당 하나의 감지기만 설치하면 됨
    보통 TCPDump 기반의 Snort 침입탐지시스템을 기본으로 여김
    공격에 대한 결과, 암호화된 내용을 알 수 없음
    감시 영역이 상대적으로 넓고 IP 주소 기반이 아니므로 직접적인 해커의 공격은 거의 완벽한 방어 가능, 존재 여부 숨기기 가능

  * 호스트 기반 : 개인 워크스테이션/서버에 설치되어 있음, 비정상적이거나 변칙적인 행위 탐지

    네트워크 환경과 무관함
    운영체제 계정에 따른 사용자가 어떤 접근을 시도하고, 어떤 작업을 했는지 기록 추적
    운영체제 취약점은 HIDS 손상 가능, 다른 IDS보다 비용이 많이 듬

* 탐지시점에 따라

  * 사후분석

  * 실시간 탐지

## IDS의 위치

목적에 따라 여러 곳에 설치할 수 있다.

### NIDS의 위치

      1        2        3                           4                                5
인터넷 : 라우터 : 방화벽 : 라우터 : [ {방화벽:}DMZ(서버를 위한 네트워크)  , 내부 클라이언트를 위한 네트워크 ]
우선순위 : 3 -> 4 -> 5 -> 2 -> 1

* 1{패킷이 라우터로 오기 전}

  네트워크에 들어오는 모든 공격을 탐지할 수 있다.
  너무 많은 공격에 대해 수집해 네트워크에 치명적인 공격에 대해 대처할 수 없다.

* 2{라우터 뒤}

  라우터의 패킷 필터링을 거친 후의 패킷을 검사한다.
  좀 더 강한 의지가 있는 공격을 검사할 수 있다.

* 3{방화벽 뒤} : 침입탐지시스템을 한 대만 설치할 경우 이곳에 설치한다.

  네트워크에 영향을 줄 수 있는 공격을 탐지한다.
  공격에 대한 정책과 방화벽과의 연동성이 가장 중요한 부분이다.
  내부 공격자도 탐지할 수 있다.

* 4{DMZ}

  아주 능력이 뛰어난 외부 공격자와 내부 공격자들에 의한 중요 데이터 손실이나 서비스의 중단을 막는다.

* 5{내부 클라이언트}

  방화벽이 보호할 수 없는 내부 클라이언트를 보호한다.


### HIDS의 위치

보통 중요한 시스템에 설치한다. 유지 관리 비용이 많이 드므로, 웹 서버 등에만 설치한다.

## IDS 응용

### 긍정오류(False positive)와 부정오류(False Negative)

침입자의 행위와 합법적 사용자의 행위가 겹치는 부분에서 발생할 수 있는 오류이다.

* 긍정오류 : 정상적 행위를 공격으로 인식하는 경우이다. (Type I Error)

* 부정오류 : 침입자를 합법적 사용자로 판단하게 되는 오류이다. (Type II Error)

### 분산 침입탐지

* 호스트 에이전트 모듈

  모니터링하는 시스템에서 작동하는 모듈이다. 보안관런 사건에 대해 데이터를 수집해 중앙 관리자에 전송한다.

* LAN 모니터 에이전트 모듈

  LAN 트래픽을 분석해 전송한다.

* 중앙관리자 모듈

  침입을 탐지하기 위해 데이터를 전송받아 처리한다.

### 허니팟

보안문제를 해결하지는 않지만 잠재적 공격자에 대해 조기 경보 제공, 보안 전략의 결점 파악, 전반적인 보안 메커니즘 향상을 목적으로 한다.

자료를 가진 호스트인 것처럼 존재하며 해커, 내부자에게 침해당해 그들의 행동, 공격기법, 목적 등을 분석한다.

#### 설계목표

* 중요한 시스템에 접근하는 공격자를 다른 방향으로 돌린다

* 공격자의 동작에 관한 정보를 수집한다

* 공격자로 하여금 시스템에 충분히 오랜 시간 동안 머무르기를 유도한다

#### 특징 : [ 허니팟 -> 분석시스템 -> 대응시스템 ] ==> 서버, 사용PC

* 성능이 시스템 자원에 영향을 받지 않는다. (자신이 받은 패킷만 수집한다)

* Port listener, Scan Detector도 허니팟으로 활용할 수 있다.

* 고의적으로 취약점을 내포하고 있어 Zero-day를 방지할 수 있다.

* 공격을 허니팟으로 유인해 시스템 논리적인 파괴 및 손실을 방지한다.

|구분      |     유인          | 함정 |
|---------|------------00------------|-------------------------|
|대상 |허가되지 않은 접근 시도한 책임자 | 침입의 의도가 없는 사용자 |
|목적 |침입의 흔적을 증거로 남기기 위함 | 범죄를 유발함 |
|합법여부| 합법, 윤리적  |   불법, 비윤리적 |
|기타| 증거를 잡아내기 위해 범죄 순간을 충분히 오래 유지 | 의사가 없던 사람에게 범죄를 저지르도록 이끔 |

#### 단점

* 자신에게 오는 패킷만 수집하므로 네트워크 전반에 대한 침입정보를 분석할 수 없다

* 허니팟을 알아차리게 되면 우회하거나 마비시킬 수 있다

## Snort

실시간 트래픽 분석, 프로토콜 분석, 내용검색/매칭, 침입탐지 Rule에 의해
오버플로우, 포르 스캔, CGI 공격, OS확인 시도 등 다양한 공격과 스캔을 탐지할 수 있다

### Snort 룰 (시그니처) 형식

```bash
alert tcp $EXTERNAL_NET any -> $HTTP_SERVERS $HTTP_PORTS (msg:"NII SQL Injection-paranoid");
flow:to_server,established;uricontent:".pl";pcre:"(\%27)|(\')|(\-\-)\(%23)\(#)/i";classtype:web-application-attack;sid:9099;rev:5;)
```

* 룰 헤더, 옵션의 2가지 섹션으로 분류한다.

  * 룰 헤더 : 처리방법, 프로토콜, 출발지/목적지 주소정보를 기술한다.

  * 룰 옵션 : alert message, 페킷 데이터를 조사하기 위한 내용을 기술한다.

* 형식

  `alert tcp 192.168.159.0/24 any -> 192.168.159.131 80`

* 룰 헤더 필드

  * action

    alert : alert를 발생시키고 로그에 남긴다
    log : 로그에 남긴다
    pass : 무시한다
    activate : alert를 발생시키고 대응하는 dynamic action을 활성화한다
    dynamic : activate가 발생하면 log과 동일한 액션을 취한다
    drop : iptables를 통해 패킷을 차단하고 로그를 남긴다
    reject : TCP - RST, UDP - ICMP Unreachable
    sdrop : Simple drop

  * protocol : TCP, UDP, ICMP, IP

  * IP

    복수개 IP (10.10.10.0/24), 11.11.11.11, 부정 연산자 사용 : !10.10.10.0/24

  * port

    1:1024, :1024, 1024:

  * Direction : ->, <- , <> (양방향)

* 룰 옵션

  msg
  content : 패킷의 payload 내부를 검색한다
  offset : content 검사 시작하는 오프셋
  depth : 검사할 바이트수 (빠른 검색을 위해)
  nocase : 대소문자를 구분하지 않는다
  sid : (~100):예약, (100~100만) : www.snort.org에서 배포하는 룰, (100만:) 커스텀 룰
  flow : TCP계층의 reassembly 시 : established(통신 성립) / stateless(상태 상관없이, 비정상 무작위공격 대비)
  rev : 룰 수정 횟수