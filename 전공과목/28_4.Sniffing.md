# 스니핑

네트워크 트래픽들 도청하는 것이다.

## 스니핑의 종류

### 허브 환경에서의 스니핑

허브는 들어온 패킷을 패킷이 들어온 포트를 제외한 모든 포트에 보내는 장비이다.
따라서 허브를 사용하고 있다면 계속 다른 사람들의 패킷을 받아볼 수 있다.
하지만 패킷은 네트워크 드라이버, OS 커널 수준에서 MAC 주소가 불일치하면 버려진다.

NIC를 promiscuous 모드로 동작하게 하면 버리지 않고 받을 수 있다.

### 스위치 환경에서의 스니핑

* 스위치 재밍 (Switch Jamming)

MAC Address Table 버퍼를 오버플로우시켜서 스위치가 허브처럼 동작하게 강제적으로 만든다.
Fail Open - 시스템이 오작동하면 모두 허용하는 정책을 이용한다.
MAC 주소를 계속 변경하며 ARP Reply 패킷을 지속적으로 전송하면 된다.

* ARP 스푸핑

특정 호스트의 MAC 주소를 자신의 MAC 주소로 위조한 ARP Reply 패킷을 만든다.
희생자의 ARP Cache에 특정 호스트의 MAC정보가 공격자의 MAC정보로 변경된다.
호스트 대 호스트 공격이다.

* ARP 리다이렉트

자신이 라우터인 것처럼 MAC주소를 위조해 ARP Reply패킷을 해당 네트워크에 broadcast하면 LAN의 모든 호스트와 라우터 사이의 트래픽을 스니핑하고, IP Forward 기능을 통해 사용자가 눈치채지 못하도록 한다.
공격자 자신은 원래 라우터의 MAC 주소를 알아야 한다.

이 둘은 2계층 공격이다.

* ICMP 리다이렉트

3계층에서 스니핑 시스템을 네트워크에 존재하는 또 다른 라우터라고 알린다.
로드밸런싱을 이용하며, 시스템의 라우팅 테이블에 라우팅 엔트리를 하나 더 넣거나 ICMP 리다이렉트 방법을 사용한다.

    호스트 A {라우터 1{=>인터넷}, 라우터 2{=>호스트 B}} 상황에서,
    1. 호스트 A에 라우터 1이 기본 라우터로 설정되어 있어, 호스트 A는 원격 호스트 B로 보낼 때 라우터 1로 보낸다.
    2. 라우터 1은 라우팅 테이블을 검색해 대상을 라우터 2로 판단해 해당 패킷을 라우터 2로 보낸다.
    3. 라우터 1은 호스트 B을 향하는 패킷을 A가 다시 전달하지 않도록 A에 ICMP 리다이렉트 패킷을 보낸다.
    4. 호스트 A는 라우팅 테이블에 호스트 B에 대한 값을 추가하고, 호스트 B로 보내는 패킷은 라우터 2로 전달한다.

공격 방법은 공격자가 라우터 2로 가 되는 것이다.
ICMP 리다이렉트 패킷도 공격대상에 보낸 후 라우터 A에 다시 릴레이시켜주면 모든 패킷을 스니핑할 수 있다.

    1. 공격자는 ICMP Redirect를 대상에게 보낸다.
    2. 공격 대상은 이후 공격자에게 모든 패킷을 보낸다.
    3. 눈치채지 못하도록, 패킷을 복사해 원래 라우터에 보낸다.

* SPAN 포트 태핑 공격

스위치의 포트 미러링 기능을 이용한다. (IDS, 네트워크 모니터링/로그 시스템을 설치할 때 이용한다)

### 스니핑 공격의 보안 대책

* 능동적인 대응책 : 스니퍼가 네트워크에 존재하는지를 알아보는 방법 (스니퍼 탐지)

* 수동적인 대응책 : 스니핑을 수행하더라도 해당 내용이 노출되지 않도록 통신 내용을 암호화

* 스니핑 탐지

    스니퍼가 프러미스큐어스 모드에서 작동하므로, 유입 패킷에 대한 IP 주소와 MAC 주소를 필터링하지 않는다.
    ping : 네트워크에 존재하지 않는 MAC 주소를 위장해 보내 Reply를 받으면 해당 호스트가 스니핑을 하고 있는 것이다.
    ARP : 위조된 ARP Request를 보내 ARP Response가 오면 프러미스큐어스 모드로 설정되어 있는 것이다.
    DNS : 스니핑한 주소로 inverse-DNS lookup을 수행한다. 테스트 대상 네트워크로 Ping Sweep을 보내고 들어오는 Inverse  DNS Lookup을 감시해 스니퍼를 탐지한다.
    유인(Decoy) 방법 : 가짜 계정과 패스워드를 네트워크에 계속 뿌려, 이 접속을 시도하는 시스템을 탐지한다.
    ARP watch : 초기에 MAC 주소와 IP 주소의 매칭 값을 저장해 ARP 트래픽을 모니터링해 이를 변하게 하는 패킷이 탐지되면 관리자에게 메일로 알려주는 툴이다.
    대부분의 공격 기법이 위조된 ARP를 사용하기 떄문에 이를 쉽게 탐지할 수 있다.

* 암호화

서비스에 따라, 인터넷/이메일을 사용할 때의 암호화 방법 등 다양하다.

SSL : 40bit/128bit 키 사용
PGP, PEM, S/MIME : 이메일 암호화
SSH : 텔넷 서비스 암호화
VPN : 공용 회선을 이용한 사설 암호화 망

## 스니퍼

패킷/LAN 세그먼트상을 지나는 트래픽을 분석할 수 있는 프로그램 혹은 장비를 가리키는 용어이다.

스니퍼는 무차별 모드로 동작하는 네트워크를 이용해 네트워크에 접속해, 데이터를 갭쳐한다.

## Spoofing

* IP Spoof : 3계층, 다른 컴퓨터의 IP 주소 이용

* Email : 이메일 발신자 위장, 7계층

* Web : 중간에서 웹 페이지 내용을 가로채 원래 웹페이지 내용 변경, 7계층

* DNS : DNS를 사칭해 해당 웹페이지 주소가 아닌 IP 반환, 7계층

### ARP 스푸핑

ARP는 IP->MAC
ARP 캐시는 자주 폐기되므로 공격자가 ARP를 위조하면 빠른 시간 내에 캐시를 갱신한다.

* 보안 대책

DMZ를 관리하는 사람이 이를 시도하면 거의 100% 성공한다.
보안 사고의 50% 이상이 내부자의 소행이므로, 중요 시스템이 ARP 스푸핑되는 것은 막아야 한다.
static 옵션 지정이 필요한데 (arp -s IP MAC), 모든 시스템에 작업하기 번거롭고 리부트 시 static 옵션이 사라지므로 배치 파일 형태로 리부팅 시마다 자동으로 수행되도록 해야 한다.

### IP 스푸핑

신뢰관계에 있는 IP로 위장한 뒤 rlogin 등으로 서버에 접속하고 백도어 등을 설치한다.

* 공격 절차

공격자(A) => 공격 대상(B) <=> 서버 C

C가 B와 통신을 하고 있을 때 C에게는 서비스 거부 공격(TCP Syn Flooding)을 하며 B와는 자신을 C로 위장해 통신한다.

* 대응 방안

외부 패킷에서 내부망 IP 주소로 들어오는 패킷을 필터링한다.
내부 사용자 공격은 막을 수 없으므로 각 시스템에 TCP Wrapper, ssh 등을 설치해 운영한다.
rlogin등 패스워드 인증 과정이 없는 서비스는 사용하지 않는다.
트러스트를 사용할 경우 트러스트된 시스템의 MAC 주소는 static으로 지정한다.

### DNS 스푸핑

윈도우 : ipconfig/all
리눅스 : /etc/resolv.conf, /etc/sysconfig/network-scripts/ifcfg-x

DNS 스푸핑은 실제 DNS 서버보다 빨리 공격 대상에게 DNS Response 패킷을 보내 공격 대상이 잘못된 IP 주소로 웹 접속을 하도록 유도한다.
DNS 패킷은 UDP이므로 세션이 존재하지 않고, 먼저 도착한 패킷을 신뢰하며 다음 도착한 정보를 보낸다.

* 웹 스푸핑

중간자공격에서 사용되며, 공격 대상에게 오고 가는 모든 트래픽이 공격자를 통과하도록 구성해 트래픽을 가로챈다.
위장 사이트를 개설해 신용카드 정보/쿠키 정보 등을 가로챈다. 정상적인 서비스를 방해하므로 DoS 공격으로도 볼 수 있다.

* 공격 절차

DNS Query 패킷을 보내는 것을 확인해야 한다.
스위칭 환경이면 ARP 스푸핑이 필요하며, 허브를 쓰고 있다면 모든 패킷이 자신에게도 전달되므로 자연스럽게 확인할 수 있다.
공격자는 로컬에 존재하므로 DNS 서버보다 지리적으로 가까우므로, DNS Response 패킷을 보낸다.
또는 네트워크의 특정 URL에 거짓 IP 정보를 계속 브로드캐스팅한다.

* 방어대책

캐시에 도메인 이름에 대한 Ip 주소가 저장되었다가 캐시에 읽어들여 hosts 파일을 통해 IP주소를 해석한다.
따라서 hosts 파일에 중요 사이트의 IP 주소를 확인해 적어둔다.

DNS 서버에 대한 DNS 스푸핑도 가능한데, BIND를 최신 버전으로 바꾸면 PTR 레코드, A레코드 정보까지 확인한 후 네인 서버의 데이터베이스 파일 변조 여부까지 판단한다.

다른 방법으로 다른 DNS 서버와 매핑 테이블 비교, 역 DNS를 사용해 호스트-IP / IP-호스트명을 비교한다.

### 이메일 스푸핑

공격자의 신분을 위장하여 이메일을 발송하는 공격이다.

## 세션 하이재킹

서버와 클라이언트가 TCP를 이용해 통신하고 있을 떄, RST 패킷을 보내 TCP 세션을 끊고 시퀀스 냄버를 새로 생성해 세션을 빼앗아 인증을 회피한다.

원격 세션 하이재킹(Blind Attack)은 원격에서 TCP 시퀀스 넘버를 확인할 수 없을 때 추측으로 세션을 하이재킹한다.
로컬 세션 하이재킹은 세션을 탐지할 수 있는 상태에서 세션 하이재킹을 한다.

인증에 대한 문제점을 해결하기 위한 OTP, 토큰 기반 인증(Kerberos 포함)을 이용한 세션도 갈취 가능하다.

### 특징

시퀀스 넘버에 따른 TCP 연결 상태 : 동기화 / 비동기화
정상적인 접속의 경우 - 시퀀스 넘버 동기화, 서로 일치
비동기화를 만드는 방법 :
    서버에서 초기 설정 단계의 접속을 끊고 다른 시퀀스 넘버로 새로운 접속 생성
    대량의 null 데이터를 보내는 방법

TCP 세션 하이재킹 - 명령의 실행 가능 (클라이언트와 똑같은 인터페이스 제공) : 적극적 공격
연결을 끊었을 때 클라이언트가 정상적인 패킷을 보내면 서버는 정상적이지 않은 시퀀스 넘버로 인식, 시퀀스 넘버를 맞추기 위한 작업 진행 (무한히 반복되는 경우 - ACK 스톰)
hunt라는 툴을 이용함

### 공격 절차

공격자는 스니핑을 해 세션을 확인하고 적절한 시퀀스 넘버를 획득한다.
RST 패킷을 보내 서버 쪽 연결만을 끊는다. 서버는 잠시 Closed 상태가 되지만 클라이언트는 Established 상태다.
공격자는 새로 시퀀스 넘버를 생성해 서버로 보낸다.
서버는 새로운 시퀀스 넘버를 받아들여 다시 세션을 연다.
공격자는 정상적인 연결처럼 서버와 시퀀스 넘버를 교환하고, 공격자와 서버 모두 Established 상태가 된다.

### 방어 대책

* 암호화된 연결을 사용한다.

* 몇 가지 특이점이 있어 공격 탐지 및 대응이 가능하다.

  * 비동기화 상태 탐지

    서버와 시퀀스 넘버를 주기적으로 체크해 비동기화 상태에 빠지면 이를 탐지해낸다.

  * ACK Storm 탐지

    전송 중 윈도우 크기, 시퀀스 넘버가 맞지 않는 상태가 되면 서로에 대한 교정 패킷이 정상적으로 작동하지 못하기 때문에 무한 루프에 걸리게 되 ACK 패킷의 비율이 증가한다.

  * 패킷의 유실과 재전송 증가 탐지

    공격자가 중간에 끼어 동작하므로 패킷의 유실과 재전송이 발생해 서버와 응답 시간이 길어진다.

  * Unexpected 리셋

    세션이 멈추거나 리셋되므로 클라이언트가 공격당하고 있음을 알 수 있다.

  * 세션 성립은 인증 성립을 의미하므로, 하이재킹은 인증을 위한 모든 검증을 우회한다. 최우선의 대책은 데이터 전송의 암호화다. 다음은 지속적인 인증이다.

## 각종 Remote Attack

Remote Attack으로 접근 권한을 얻어 Local attack을 수행해야 한다.

* Trojan

악의적인 프로그램을 건전한 프로그램으로 포함

* Exploit

제어 권한 획득, 서비스 거부 등 목적