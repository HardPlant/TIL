# 상황별 분석 단계

DB 서버의 CPU 사용율 80% 이상인 상황을 분석
응답 시간이 느릴 시 어디가 느린지 찾아내려면 무엇을 확인해야 하는가?

* 시스템 중요 자원의 사용량 확인, 부족 여부 확인

* 애플리케이션 서버에서 스택을 다수 수집, 각 유관 서버와 애플리케이션 코드의 성능 비중 분석

* 스택 분석

### 1.화면 응답시간 저하

if 화면 사용 가능?:
    클라이언트 자원 확인:
        if 자원 사용량 이상 있음:
            (3.6~8)과다 사용 자원 분석
        else:
            goto 클라이언트 응답시간 분석
else:
    사용자 접점 서버단 패킷 수집
    label:
        클라이언트 응답 시간 분석:
            if 서버가 느린가?:
                2.* 시스템 내 응답시간 저하
            else:
                if 클라이언트가 느린가?:
                    클라이언트 원인 분석
                else:
                    네트워크 원인 분석

if 서버단 프로그램 식별 가능?:
    애플리케이션 서버의 처리시간 확인 가능?:
        if 서버가 느린가?:
            goto 2.* 시스템 내 응답시간 저하
        else:
            goto 클라이언트 응답시간 분석

80% 이상은 시스템 내부 문제이므로 서버 내부의 처리 지연 여부 확인

##### 1.1. 클라이언트 자원 사용량 확인

클라이언트 PC의 주요 자원이 화면을 테스트하는 데 영향을 줄 가능성이 있는지 확인

도구: 윈도우 작업관리자, procexp, processhacker

CPU, 메모리, 디스크를 확인
자원 사용량 확인, 화면 사용 시 자원 사용량 증가 패턴 모니터링
화면 로직을 처리하는 데 얼마나 많은 자원이 필요한지 파악

##### 1.2. 사용자 접점 서버단 패킷 수집

성능 저하가 특정 사용자에서 발생, 사용자 PC에 직접 모니터링이 불가능한 경우
서버단에서 클라이언트 응답시간 분석

수집 도구: tcpdump, snoop, nettl, iptrace,wireshark
분석 도구: wireshark, Visual Round Trip Analyzer

특정 사용자 대상으로 네트워크 패킷을 수집해 클라이언트, 네트워크, 서버 처리시간을 각각 분석
서버는 오가는 패킷이 많기 때문에 꼭 사용자 IP 주소로 필터링

##### 1.3. 클라이언트 응답시간 분석

클라이언트 응답시간을 클라이언트, 네트워크, 서버 세 구간으로 나눠 분석
성능 저하 발생하는 구간 식별

웹 브라우저: 개발자 도구, Fiddler, HttpWatch, Dynatrace AJAX Edition(네트워크 패킷 수집 분석)
클라이언트/서버: Wireshark, VRTA, ProcessMon(윈도우 프로세스 파일, 네트워크 입출력 모니터링)

전체 응답시간이 10초라면 클라이언트 1초, 네트워크 2초, 서버 7초 같이 각 구간 소요된 시간을 구해 가장 비중이 높은 구간 식별

##### 1.4. 클라이언트 원인 분석

전체 응답시간 중 클라이언트에서 소요되는 시간이 많을 때 원인 분석

웹 브라우저: 개발자 도구, Fiddler, HttpWatch, Dynatrace AJAX Edition(네트워크 패킷 수집 분석)
클라이언트/서버: ProcessMon(파일, 네트워크 모니터링), ProcessExp, ProcessHacker(윈도우 프로세스 모니터링)

클라이언트 로직, 렌더링 시간 구분 분석
CSS, JS, 이미지 등 콘텐츠 유형과 수가 성능에 영향을 미치는 정도 분석(개발자 도구에서 시계열 처리 현황 표 Timechart 제공)

```
* 클라이언트 스크립트 로직, 렌더링 구분 분석
* 콘텐츠 유형, 개수 응답시간 상관관계 분석
* 화면 처리 흐름으로 인한 애플리케이션 턴 수
* HTML 내 자바스크립트, CSS 렌더링 영향도 분석
* 클라이언트 로깅 영향도
* 클라이언트 캐시 동작 여부 확인
* 콘텐츠 구성 방식과 크기
```

##### 1.5. 네트워크 원인 분석

전체 응답 시간 중 네트워크에서 소요되는 시간이 많을 때 원인 분석

WireShark
웹 브라우저: 개발자 도구, Fiddler, HttpWatch

각 영역에 대한 성능 영향도 분석

```
* 전송 데이터 : 전송 데이터 크기, 콘텐츠 수, 전문 형태, 압축 여부
* 통신 방식 : 프로토콜, 네트워크 연결 유지 및 연결 수, 네트워크 턴 수
* 통신 품질 : Rount Trip Time(패킷 왕복시간), Retransmission(재전송), Bandwidth(전송 대역폭)
```

### 2.시스템 내 응답시간 저하

5.서버 사용 사용량 확인(CPU/메모리/디스크 사용률 중심으로 퀵 스캔):
```py
if 자원 사용량에 이상이 있는가?:
    goto 6~8 과다 자원 사용 분석
else:
    if APM이 있는가?:
        if 느린 구성 요소를 식별할 수 있는가?:
            label:
                if 애플리케이션 서버가 느린가?:
                    if DB 서버가 느린가?
                        2.3 DB 서버 원인 분석
                    else:
                        if 연계 서버가 느린가?:
                            2.4 연계 서버 원인 분석
                        else:
                            if 애플리케이션 내부가 느린가?:
                                2.5 애플리케이션 내부 원인 분석
                else:
                    2.2 채널/웹 서버 원인 분석

        else:
            goto 2.1
    else:
        label:
            2.1 애플리케이션 서버 응답시간 분석
            goto 애플리케이션 서버가 느린가?

```

가장 먼저 APM을 확인, 서버 중요 자원 사용량/서비스 느려진 위치(DB, App내부) 확인
APM이 없다면 앱 서버에서 수집한 스택 분석

##### 2.1. 애플리케이션 서버 응답시간 분석

애플리케이션 서버를 기준으로 각 서버 구성 요소 간 응답시간 비중 분석
성능 저하 요소 식별, 중점 분석 대상 선정

스택 수집: jstack, pstack 등
스택 분석: SDPA(Stack Dynamic Performance Analyzer)
텍스트 기반 수작업 분석

서버 내 애플리케이션 프로세스 대상으로 5~10초 간격으로 수십회 이상 스택 수집
분석 도구를 활용해 애플리케이션 서버 응답시간 100%로 봤을 때 애플리케이션 코드, DB, 연계가 각각 차지하는 비중 분석

예를 들어, 수집한 스택에서
사용자 요청 처리중 스택: 100개
그중 64개: SQL
20개: 로그
일 때, 전체 응답시간에서 SQL은 65%, 로깅은 20% 비중을 차지
애플리케이션 서버의 응답시간은 빠른데 클라이언트에서 서버가 느린 것으로 분석 시, 채널단이나 웹 서버가 느린 것으로 판단

APM이 있더라도 제공 가능한 정보, 모니터링 수준이 따라 성능저하 요소를 식별하기 어렵다면 스택기반 분석 진행

##### 2.2. 채널/웹 서버 원인 분석

시스템 응답시간은 느리지만 애플리케이션 서버에서는 빠르게 응답하는 경우
채널, 웹 서버에서 애플리케이션 서버로 작업을 즉시 넘기지 못하는 원인 찾기

채널/웹 서버: 서비스 상태 모니터링(내장 모니터링 도구), 웹 엑세스 로그
운영체제: netstat
스택: jstack, pstack

서비스 스레드 부족 같은 병목 발생 여부 가장 먼저 확인
웹 서버, 애플리케이샤ㅕㄴ 서버 간 인터페이스 항목, 방식에 대한 분석 진행

* 병목발생: 큐잉 여부, 작업 중 스레드 수, 접속 클라이언트 수, 웹 KeepAlive 여부, 지속 시간

* 인터페이스: 웹 서버/앱 서버 간 동작 분석

콘텐츠 유형별 서비스 담당 서버 확인
일부 App 서버가 비정상 동작할 경우 웹 서버 서비스 분배 확인(Failover)

* 작업 분석: 채널, 웹 서버가 현재 수행 중인 기능 확인 (스택 분석)

웹 액세스 로그에 있는 처리시간 바탕, 애플리케이션 서버에서 서비스하는 콘텐츠만 느린지 웹 서버가 서비스하는 콘텐츠까지 느린지 유형별로 분석
웹 서버 자체 병목인지 다른 문제인지 확인

##### 2.3. DB 서버 원인 분석

SQL 응답시간이 느린 원인 분석
SQL 응답시간 비중이 높을 때는 특정 SQL 하나가 느린 경우도 있음
처리시간이 짧은 SQL이 많이 수행됨으로서 응답시간이 느릴 수 있음
SQL 수행 횟수가 많으 ㄴ경우 애플리케이션 로직 분석도 함께 수행

DB: DB 모니터링 도구, SQL 실행 클라이언트
스택: pstack

특정 SQL이 느린 경우 락 대기, 실행계획, 수행통계를 바탕으로 원인 분석
시스템 전반에 걸친 성능 저하인 경우 동작 중인 세션, 오라클 AWR 등 시스템 전반에 대한 운영 통계 기반 원인 분석

* 동작 중인 세션 : 현재 SQL을 수행 중인 세션 상태 (대기 이벤트)
* 락 대기 : 수행 중인 SQL간 락 영향도 확인(락 트리)
* 실행계획 : 저성능 SQL 실행계획, 실행 통계 확인
* 수행 통계: DB 운영 통계(오라클 AWR, 세션 히스토리, DBMS 통계 테이블)
* 스택 분석: SQL 서비스 프로세스에 대해 스택 수집해 분석

수행되는 SQL이 많다면 애플리케이션 로직 분석을 통해 집합 처리, 캐시, SQL 통합, 불필요한 쿼리 제거 등 개선 방안 가능

##### 2.4. 연계 서버 원인 분석

타 시스템 서비스 호출이므로 내부, 외부로 구분해 처리시간 측정이 중요함

로그: 연계 서버 거래 로그
스택: jstack, pstack

핵심은 내부 연계 서버가 느린지, 연계된 타 시스템이 느린 것인지 확인하는 것임
타 시스템이 느리다면 직접 분석, 접근에 어려움 발생함
한 서비스에서 연계가 발생하는 횟수, 유형 분석

* 연계 서버 응답시간 비중: 내부 연계 서버, 타 시스템 간 응답시간 비중
* 연계 서비스 특성: 서비스당 연계가 발생하는 횟수, 유형

연계 서버 자체 내부 성능 저하는 일반 App서버 원인 분석 과정과 동일한 방식으로 진행

##### 2.5. 애플리케이션 내부 원인 분석

수집된 스택이 핵심 자료임

APM: SQL 수행 로그(Scouter)
스택: jstack, pstack(수집), SDPA(분석)

사용자 서비스를 실행 중인 스택만 선택해 현재 실행 중인 코드를 기능 유형별로 그루핑, 비중 분석
비중이 높은 각 기능이 효율적으로 개발되 있는지, 꼭 필요한 기능인지 확인

* 병목 발생: 스레드 풀, DB 연결 풀 상태(부족 여부 확인)
* 불필요한 작업: 로깅, 모니터링, 환경 반복 로딩 등 본 서비스와 무관한 기능 수행
* 비효율적 로직: 업무 로직, 탐색 로직, 날짜/수치 연산 로직, 문자열 처리 로직
* SQL 수행 패턴 분석: 서비스당 SQL 수행 유형, 횟수 / 바인드 변수를 기준으로 한 반복 수행 여부 분석

APM이 있으면 SQL 수행 횟수, 패턴, 바인드 변수를 손쉽게 확인 가능
App 측면에서 SQL 조회 결과 캐시 가능성 검토, SQL 불필요하게 수행되는지 판단하는 등 개선 방안 도출에 유용함

APM으로 개별 App 응답시간 상세 수행로그 분석 시 앱 시작부분과 끝부분에서 응답시간이 오래 걸리는 경우가 있음
앱 내부 로직에 의할 수도 있지만, 네트워크에서 소요된 시간일 수 있음에 유의함
업로드하는 내용이 큰 경우 웹 서버는 요청 헤더만 보고 애플리케이션 서버로 라우팅했지만, 앱 서버는 요청 내용을 파싱하기 위해 모든 내용을 업로드되기를 기다리고 있을 수 있음
응답을 전송할 떄 서블릿 버퍼는 8KB인데 그 이상의 응답 데이터를 보낼 때 네트워크 전송 지연이 발생 시 서블릿 버퍼가 비워지기를 기다리느라 애플리케이션 종료되지 않고 마지막 부분에서 기다릴 수 있음

### 3.서비스 멈춤 현상

```py
5.* 서버 자원 사용량 확인
if 자원 사용량에 이상이 있는가?:
    6~8 과다 사용 자원 분석
else:
    3.1 애플리케이션 스택 분석
    if 스택에 이상이 없는가?:
        채널/웹 서버:{스레드 풀 소진, 긴 KeepAlive}
    else if DB 서버가 느린가?:
        DB 서버{락 대기, 교착 상태 대기, 전체 테이블 탐색, 저성능 쿼리}
    else if 연계 서버가 느린가?:
        연계 서버{타 시스템 응답 대기, 통신 이상, 스레드 풀 소진}
    else 애플리케이션 내부가 느린가?
        애플리케이션 서버{락 대기,교탁상태 대기, 스레드 풀 소진, DB 연결 풀 소진, 무한반복 로직}
```

프로세스가 거의 멈춘 상태로 더 이상 사용자 요청을 처리하지 못하는 경우
자원 부족여부 확인 후 애플리케이션 상태 확인

서버 자원은 CPU 사용량, 메모리 스와핑 여부 확인
DB 서버는 데이터 캐시 영역이 스왑 영역으로 내려가면 급격한 성능 저하 발생
자바 프로세스는 Full GC로 멈출 수 있으므로 먼저 GC 상태 모니터링

자원에 문제가 없을 시 애플리케이션 스택이 핵심 정보임
락 영향도, 현재 수행 중인 기능, 작업 스레드 소진 등에 관한 정보 습득 가능
시스템 콜 모니터링 : 해당 애플리케이션이 완전히 멈춰있는지, 동작하고 있지만 너무 느려 멈춰있는 것처럼 보이는지

완전히 멈춘 경우:
DB에서 대량 테이블에 대해 전체 테이블 탐색 수행한 경우
애플리케이션이 무한 반복에 빠진 경우

##### 3.1. 애플리케이션 스택 분석

스택 분석을 통해 사용자 서비스가 멈춰 있거나 느린 위치를 확인하고 원인을 파악해 분석

스택 수집: jstack, pstack, kill -3, gcore(프로세스 덤프 기반으로 스택 확인)
멈춤 분석은 텍스트 기반 수작업 분석이 빠름
프로세스 동작 확인(시스템 모니터링): truss, tusc, strace, ProcessMon

멈춤 현상을 분석하기 위해 스택 수집 시 5~10초 간격으로 2~10번 스택 수집하는 것만으로 충분함
멈춤 현상일 떄는 대부분 스레드가 멈춤을 유발한 특정 기능에 몰려 있는 경우가 대부분임, 일반 성능보다 분석 용이
모든 스레드가 특정 쿼리 수행하는 데 통신 소켓을 읽고 있는 상태라면, 해당 쿼리가 DB 서버 내부에서 락 대기, 너무 많은 블록에 액세스에서 발생
해당 쿼리가 수행되는 DB 세션의 상태 확인
대부분 스레드가 DB의 getConnection() 메서드에서 대기하고 있을 시 DB 연결 풀 수 부적, 연결 누수 의심

### 4.시스템 전반에 걸친 성능 개선

특정 애플리케이션이 아닌 시스템 전체에 대한 성능 개선 진행

대상 애플리케이션, SQL을 식별하는 것이 우선
수행 빈도, 총 수행시간이라는 측면에서 비중이 가장 높은 것부터 개선 가능성 검토

전문 파싱, 전문 생성 등 가볍지 않은 기능이 자원 측면에 큰 영향을 줌
수행 빈도를 줄일 수 있는 방안 강구 필요

SQL은 사용 블록 수의 합이 가장 큰 것들을 대상
SQL 튜닝의 핵심은 동일한 결과를 얻지만 더 작은 블록을 사용하게 하는 것

APM, DB 모니터링 도구 등 수행 통계를 제공하는 솔루션이 있으면 수월함
여의치 않으면 스택을 수집해 성능 통계를 만들어야 함

```
애플리케이션 수행 통계 수집:*소스: APM, 액세스 로그, 운영 로그, 스택
    응용 수행시간 총합 Top 10
    응용 수행횟수 Top 5
    프레임워크 개선 대상 (스택 분석)
DB 수행 통계 수집: *소스: DB 모니터링 도구, DB 내부 통계, APM
    SQL CPU 사용 총합 Top 10
    SQL 수행시간 총합 Top 10
    SQL 사용 블록 총합 Top 10
    SQL 수행 횟수 Top 5

대상 선별 후 개선 가능성 검토
```

##### 5. 서버 자원 사용량 확인

if CPU 사용량이 높은가?: *CPU 사용량<80%, Run-queue<=3 (Core당)
    6.* CPU 과다 사용 분석
else:
    if CPU System 사용율이 높은가?: *보통 System/User 비율 1/3 이내
        6.* CPU 과다 사용 분석
    else:
        if CPU IO Wait 사용율이 높은가?: *보통 IOWait/전체 비율 1/4 이내
            goto 디스크 서비스 시간이 높은가
        else:
            if 메모리가 부족한가?: *Page scan rate, Page out 지속적 발생
                if 메모리 누수가 있는가?:
                    메모리 누수 분석
                else:
                    7.* 메모리 과다 사용 분석
            else:
                if 자바가 주 언어인가?:
                    if 자바 메모리 누수가 있는가?
                        메모리 누수 분석
                    if GC 시간 비중이 높은가?
                        GC 튜닝
                else:
                    if 디스크 서비스 시간이 높은가?: *디스크 사용율 < 80%, 디스크 시간 < 30%
                        8.* 디스크 과다 사용 분석
                    else:
                        완료

##### 6. CPU 과다 사용 분석



##### 7. 메모리 과다 사용 분석

##### 8. 디스크 과다 사용 분석
