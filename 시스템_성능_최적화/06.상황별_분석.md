# 상황별 분석 단계

DB 서버의 CPU 사용율 80% 이상인 상황을 분석
응답 시간이 느릴 시 어디가 느린지 찾아내려면 무엇을 확인해야 하는가?

* 시스템 중요 자원의 사용량 확인, 부족 여부 확인

* 애플리케이션 서버에서 스택을 다수 수집, 각 유관 서버와 애플리케이션 코드의 성능 비중 분석

* 스택 분석

### 화면 응답시간 저하

80% 이상은 시스템 내부 문제이므로 서버 내부의 처리 지연 여부 확인

* 클라이언트 자원 사용량 확인

클라이언트 PC의 주요 자원이 화면을 테스트하는 데 영향을 줄 가능성이 있는지 확인

도구: 윈도우 작업관리자, procexp, processhacker

CPU, 메모리, 디스크를 확인
자원 사용량 확인, 화면 사용 시 자원 사용량 증가 패턴 모니터링
화면 로직을 처리하는 데 얼마나 많은 자원이 필요한지 파악

* 사용자 접점 서버단 패킷 수집

성능 저하가 특정 사용자에서 발생, 사용자 PC에 직접 모니터링이 불가능한 경우
서버단에서 클라이언트 응답시간 분석

수집 도구: tcpdump, snoop, nettl, iptrace,wireshark
분석 도구: wireshark, Visual Round Trip Analyzer

특정 사용자 대상으로 네트워크 패킷을 수집해 클라이언트, 네트워크, 서버 처리시간을 각각 분석
서버는 오가는 패킷이 많기 때문에 꼭 사용자 IP 주소로 필터링

* 클라이언트 응답시간 분석

클라이언트 응답시간을 클라이언트, 네트워크, 서버 세 구간으로 나눠 분석
성능 저하 발생하는 구간 식별

웹 브라우저: 개발자 도구, Fiddler, HttpWatch, Dynatrace AJAX Edition(네트워크 패킷 수집 분석)
클라이언트/서버: Wireshark, VRTA, ProcessMon(윈도우 프로세스 파일, 네트워크 입출력 모니터링)

전체 응답시간이 10초라면 클라이언트 1초, 네트워크 2초, 서버 7초 같이 각 구간 소요된 시간을 구해 가장 비중이 높은 구간 식별

* 클라이언트 원인 분석

전체 응답시간 중 클라이언트에서 소요되는 시간이 많을 때 원인 분석

웹 브라우저: 개발자 도구, Fiddler, HttpWatch, Dynatrace AJAX Edition(네트워크 패킷 수집 분석)
클라이언트/서버: ProcessMon(파일, 네트워크 모니터링), ProcessExp, ProcessHacker(윈도우 프로세스 모니터링)

클라이언트 로직, 렌더링 시간 구분 분석
CSS, JS, 이미지 등 콘텐츠 유형과 수가 성능에 영향을 미치는 정도 분석(개발자 도구에서 시계열 처리 현황 표 Timechart 제공)

```
* 클라이언트 스크립트 로직, 렌더링 구분 분석
* 콘텐츠 유형, 개수 응답시간 상관관계 분석
* 화면 처리 흐름으로 인한 애플리케이션 턴 수
* HTML 내 자바스크립트, CSS 렌더링 영향도 분석
* 클라이언트 로깅 영향도
* 클라이언트 캐시 동작 여부 확인
* 콘텐츠 구성 방식과 크기
```

* 네트워크 원인 분석

전체 응답 시간 중 네트워크에서 소요되는 시간이 많을 때 원인 분석

WireShark
웹 브라우저: 개발자 도구, Fiddler, HttpWatch

각 영역에 대한 성능 영향도 분석

```
* 전송 데이터 : 전송 데이터 크기, 콘텐츠 수, 전문 형태, 압축 여부
* 통신 방식 : 프로토콜, 네트워크 연결 유지 및 연결 수, 네트워크 턴 수
* 통신 품질 : Rount Trip Time(패킷 왕복시간), Retransmission(재전송), Bandwidth(전송 대역폭)
```

### 시스템 내 응답시간 저하

가장 먼저 APM을 확인, 서버 중요 자원 사용량/서비스 느려진 위치(DB, App내부) 확인
APM이 없다면 앱 서버에서 수집한 스택 분석

* 애플리케이션 서버 응답시간 분석

* 채널/웹 서버 원인 분석

* DB 서버 원인 분석

* 연계 서버 원인 분석

* 애플리케이션 내부 원인 분석

### 서비스 멈춤 현상

프로세스가 거의 멈춘 상태로 더 이상 사용자 요청을 처리하지 못하는 경우
자원 부족여부 확인 후 애플리케이션 상태 확인

서버 자원은 CPU 사용량, 메모리 스와핑 여부 확인
DB 서버는 데이터 캐시 영역이 스왑 영역으로 내려가면 급격한 성능 저하 발생
자바 프로세스는 Full GC로 멈출 수 있으므로 먼저 GC 상태 모니터링

자원에 문제가 없을 시 애플리케이션 스택이 핵심 정보임
락 영향도, 현재 수행 중인 기능, 작업 스레드 소진 등에 관한 정보 습득 가능
시스템 콜 모니터링 : 해당 애플리케이션이 완전히 멈춰있는지, 동작하고 있지만 너무 느려 멈춰있는 것처럼 보이는지

완전히 멈춘 경우:
DB에서 대량 테이블에 대해 전체 테이블 탐색 수행한 경우
애플리케이션이 무한 반복에 빠진 경우

* 애플리케이션 스택 분석

### 시스템 전반에 걸친 성능 개선

특정 애플리케이션이 아닌 시스템 전체에 대한 성능 개선 진행

대상 애플리케이션, SQL을 식별하는 것이 우선
수행 빈도, 총 수행시간이라는 측면에서 비중이 가장 높은 것부터 개선 가능성 검토

전문 파싱, 전문 생성 등 가볍지 않은 기능이 자원 측면에 큰 영향을 줌
수행 빈도를 줄일 수 있는 방안 강구 필요

SQL은 사용 블록 수의 합이 가장 큰 것들을 대상
SQL 튜닝의 핵심은 동일한 결과를 얻지만 더 작은 블록을 사용하게 하는 것

APM, DB 모니터링 도구 등 수행 통계를 제공하는 솔루션이 있으면 수월함
여의치 않으면 스택을 수집해 성능 통계를 만들어야 함

### 서버 자원 사용량 확인

### CPU 과다 사용 분석

### 메모리 과다 사용 분석

### 디스크 과다 사용 분석
