# 성능 개선의 기본 자세

* 적극적이고 도전적인 자세를 갖춰라

적극적이고 도전적인 자세가 적절한 기술 지식과 합쳐질 때 기대 이상의 성과가 도출됨
시스템 성능 저하 부분을 식별할 수 있는 작은 지식이 더해질 필요

* 다른 사람의 설명과 의견에 귀 기울여라

한 명보다는 두 명이 낫고 두 명보다는 세 명이 함께할 때 성과가 좋음
다양한 아이디어가 있음

고객, 시스템 운영담당자에 귀를 기울일 필요가 있음
시스템 개발, 운영하는 사람들이 시스템 특성에 대해 가장 잘 알고 있음
성능 저하, 장애를 직접 겪으며 본 현상이 실마리를 제공

* 종합적인 시각을 가져라

성능 개선, 장애조치를 하려면 숲 전체를 조망할 필요가 있음
솔루션 간 연동에 업무 특성이 나타나며 문제가 어려워짐
시스템이 상호 동작하는 방식을 이해하는 노력 필요

타 분야에 대한 지속적인 관심, 학습 필요
시스템을 하나의 유기체로 보고 애플리케이션, 네트웤, 서버 자원에 대한 내용을 다루는 것이 필요

* 실행하고 비교하라

성능에 영향이 간다고 판단되는 부분 : 직접 이리저리 수정해보고 기존 성능과 차이가 있는지 비교
다양한 코드를 보고 조금이라도 나은 코드가 무엇인지 고심할 필요가 있음

## 성능 분석 시작하기

특정 솔루션에 얽매이지 말고 자신만의 프로그램 분석 기법으로 문제의 원인을 식별할 수 있어야 함

운영체제, 프리웨어, 오픈소스 형식의 여러 도구가 있음

* 성능 저하 발생 시 맨 먼저 하는 것

네트워크를 기준으로 각 서버가 전체 응답시간에서 차지하는 비중을 분석해 영향도가 큰 집중 분석 대상을 선정하는 것

경유하는 서버가 많을 경우 초기 응답시간 분석은 애플리케이션 서버, 클라이언트 두 곳에서 수행

운영팀에서 서버 내 처리시간을 먼저 확인

내부 처리시간이 사용자 체감 응답시간과 차이가 있는 지 확인하고 클라이언트 응답시간 분석을 수행

##### 애플리케이션 서버 응답시간 분석

대내연계, 대외연계, DB, 내부 처리시간으로 분리해 분석

* APM

직관적인 데이터 수집 가능
DB 이외 서버 인터페이스에는 추가 프로파일링 설정 필요
많은 설정은 서버 성능 저하를 가져옴

* 애플리케이션 스택 수집

주기적으로 스택을 수십회 이상 수집해서 분석
현재 통신 소켓을 읽거나 쓰고 있는 스택 하위에 있는 연계 인터페이스 메서드 식별
각 구성 요소간 응답시간 비중 분석

* 프레임워크 로깅

각 구성 요소에 소요된 처리시간을 서비스 요청 단위로 로깅
자바 ThreadLocal, C/C++ 스레드 변수를 사용해 구현

응답시간 비중 분석에서 구성 요소 중 한 곳에서 성능 저하 발생 시, 해당 서버 내부에서 다시 세분화된 응답시간 분석

##### 클라이언트 응답시간 분석

네트워크 기준으로 클라이언트 처리시간, 네트워크 처리시간, 서버 처리시간으로 나눠 분석
+ DNS 룩업 처리시간 추가

추가적으로 통신 방식, 콘텐츠 구성, 전송 데이터 크기가 성능에 미치는 영향 분석

클라이언트에서 네트워크 패킷을 수집해 분석
사용자의 제반 환경에 대한 조사, 이해가 필요
원격 접속 불가 시 해당 사용자와 주고받은 네트워크 패킷을 수집해 클라이언트 응답시간 분석

## 개선 방향성

성능 개선 방안

* 병렬/분산 처리

화면 내 서비스 요청을 병렬로 처리할 수 있는가?
서버 내 오래 걸리는 작업들을 병렬로 처리할 수 있는가?
Web, App 서버의 작업 스레드 풀, DB 연결 풀 등 병렬 자원을 늘릴 수 있는가?
트랜잭션이 집중되는 테이블은 파티션으로 분산할 수 있는가?
DB를 분산저장(Sharding)해서 사용자 요청을 분산할 수 있는가?
파일 입출력을 분산해 병렬 처리할 수 있는가?

* 비동기 처리

화면에서 처리시간이 오래 걸리는 항목을 비동기 처리할 수 있는가?
온라인 서비스에 필수 작업 이외 부가 기능을 후행(비동기)처리할수 있는가?
디스크 입출력을 비동기 처리할 수 있는가?
업무 처리와 로깅 작업을 비동기로 분리할 수 있는가?

* 캐시

반복 사용되는 DB 조회 결과를 캐시할 수 있는가?
반복되는 계산 값을 캐시할 수 있는가?
프레임워크/애플리케이션 로직의 기초 데이터는 캐시됬는가?
상품 팩토리처럼 변경주기 길고 빈도는 낮은 기준 정보를 캐시할 수 있는가?
화면 콘텐츠 변경이 빈번하지 않다면 캐시할 수 있는가?
게시판 목록 같은 포털 메인 화면의 일부를 캐시할 수 있는가?

* 집합 처리

처리 건수가 많은 DB DML은 집합 처리할 수 있는가?
DB Fetch 건수는 적절한가?
파일을 읽고 쓸 때 레코드 단위로 처리하는가? 읽고 쓰는 단위가 너무 작지 않은가?
네트워크 데이터는 대량으로 송수신하고 있는가?
웹 화면에서 HTTP 호출 수를 줄일 수 있는가? (애플리케이션 턴 수)

* 오버헤드 제거

필요한 결과를 위해 최적화된 로직인가?
불필요하게 수행되는 쿼리/로깅이 없는가?
업무 로직에서 필요 이상의 DB 데이터를 조회하는가?
스레드 내/스레드 간 반복 수행되는 기능을 제거할 수 있는가?
필요 이상으로 크게 설정된 자원이 존재하는가?

* 경합 제거

배타적으로 락을 획득해 수행하는 코드가 락 범위가 필요한 부분만으로 최소화됬는가?
업무 처리 단계에서 DB 락을 최소화하도록 경합 DML이 로직 뒤에 위치하는가?
로그 파일에 경합이 발생하고 있는가?

* SQL 개선

실행계획은 적절한가? (적절한 인덱스, 전체 테이블 탐색하는 SQL 존재 여부)
주기적으로 테이블 통계가 갱신되고 있는가?
SQL의 바인드 변수 처리는 잘 되 있는가?

* 송수신 효율화

송수신 전문은 네트워크 특성을 고려해 적절한 크기를 가지는가?
네트워크 턴 수를 줄일 수 있는가?
압축해서 전송할 수 있는가?
전송하는 이미지는 크기를 최소화하는 이미지 품질, 포맷을 가지고 있는가?
네트워크 전송 품질(RTT, 재전송)를 개선할 수 있는가?

* 자원 사용 효율화

CPU를 많이 사용하는 함수를 개선/대체할 수 있는가?
메모리 사용량을 줄일 수 있는가?
메모리 누수를 제거할 수 있는가?
불필요한 파일 IO를 제거할 수 있는가?
자바 GC를 효율적으로 수행할 수 있는가?
자바 GC를 효율화하기 위해 메모리 사용 패턴을 개선할 수 있는가?

* 물리적 자원 증설

CPU, 디스크, 메모리 등 서버 자원 중 증설이 필요한 자원이 있는가?
보다 고성능 스토리지로 교체할 필요성이 있는가>
스토리지/서버 간 입출력 개선 위해 채널 수를 늘릴 필요가 있는가?
네트워크 대역폭은 여유가 있는가?