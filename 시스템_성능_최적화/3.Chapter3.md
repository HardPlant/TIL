# 성능 이론

### 기초 성능 이론

##### 서비스 요청 간격, 동시 사용자 수

서비스 요청 간격 = 응답시간 + 생각시간
동시 사용자 수 = 요청 사용자 수 + 비요청 사용자 수

리틀의 법칙:
처리량 =
    서비스 처리 건수 / 측정 시간
    요청 사용자 수 / 평균 응답시간
    동시 사용자 수 / 서비스 요청 간격

큐에 적용하면
    큐의 평균 서비스 대기 건수 = 평균 큐 처리량 * 평균 대기시간
    서비스 수행 중인 평균 건수 = 평균 큐 처리량 * 평균 서비스 시간
    큐와 서비스 수행 중에 있는 평균 건수 = 평균 큐 처리량 * (평균 대기시간 * 평균 서비스 시간)

#####  서비스 처리 건수 / 측정 시간

시간당 1,000,000건 카드 승인
TPS = 278 = 277.7778 = 1,000,000/3,600(sec)

##### 요청 사용자 수 / 평균 응답시간 (초)

요청 사용자 수 100명, 평균 응답시간 2초

사용자당 1초에 0.5TPS 처리하는 것이 됨

TPS = 50 = 100명 / 2초

요청 사용자는 실제 서버에 부하를 주고 있는 사용자임
수행중인 스레드가 100개라고 보아도 무방함

##### 동시 사용자 수 / 서비스 요청 간격 (초)

동시 사용자 수(요청+비요청) 100명이 10초마다 요청 버튼을 누를 시 초당 평균 10개 요청이 들어옴
최대 TPS=100, 행동 패턴 조사 결과 평균 30초

최대 사용자 수 = 3000명 = 100TPS * 30초
최소 사용자 수(요청 사용자 수) = 200명 = 100TPS * 2초(평균 응답시간)

웹 서버의 액세스 로그 분석 시 유용함
액세스 로그에 처리시간 기록 시 위 공식에 따라 시간 추이에 따른 동시 수행 작업 개수를 구함

* WAS 액세스 로그 바탕 분석 시

최대 스레드 설정: 90개
최대 부하일 때 로그를 분석해 최대 스레드 수를 모두 사용한 것을 알 수 있음

|시간|/msg/servlet/MeMe|msg/.../jsp|합계|
|    |----------|--------|----------------|
|    |tps|평균 응답시간|동시 작업 수|tps|평균 응답시간|동시 작업 수|초당 hit 수|동시 작업 수|
|----|---|------------|---------|----|------------|---------|----------|---------|
|8:52|5.6|0.4           |2.1    |1.2    |0.2        |0.3    |6.8        |2.3    |

```
요청 사용자 수 =

동시 사용자 수 * 평균 응답시간 / 서비스 요청 간격
동시 사용자 수 * 평균 응답시간 / (평균 응답시간+생각시간)
```
서비스가 정확히 분산되어 발생 시 동시 사용자 수, 평균 응답시간, 서비스 요청시간 => 요청 사용자 수를 구하는 공식

* 응답시간 법칙

```
(동시 사용자 수 / 처리량) - 생각시간
```
동시 사용자 수 600명, 초당 처리량 20TPS일 시:
사용자: 평균 30초마다 요청을 발생시킴
응답시간 3초이면 평균 생각시간은 27초임

## 사용율 이론

* 사용율 법칙 (Utilization Law)

```
단일 자원 사용율=
    사용 시간 / 측정 시간
    (사용 시간/ 서비스 건수) * 처리량
    서비스 시간 * 처리량
```

```
처리량 = 서비스 건수 / 측정 시간
서비스 시간 = 사용 시간 / 서비스 건수
```

```
* 복수 자원 사용율 =
    (서비스 시간 / 자원수) * 처리량
```

한 CPU가 초당 100개 데이터를 처리하며, 한 데이터 처리하는 데 1.5ms 서비스 시간이 걸릴 시
해당 CPU의 사용율 = 15%

일상적인 시스템 상황에서는 여러 구간에 병목이 존재하고 다양한 자원을 사용하게 됨
실제 적용에 한계가 있지만 성능 이해에 도움이 됨

## 비율 분석

```
* A 블록과 B 블록의 전체 처리량 =
    요청 사용자 수 / (A블록 응답시간+B블록 응답시간)
    1/((1/A블록 처리량)+(1/B블록 처리량))
n개로 확장 가능
```

120개 스레드로 동작하는 WAS하에서
평균 응답시간 4초인 A블록, 평균 응답시간이 2초인 B블록
A블록 TPS=30(120/4초), B블록 TPS=60(120/6초)

A+B블록 동시 응답 시 응답시간: 6초, TPS=20

컴포넌트나 레이어별 테스트 수행 시 성능 저하 요인으로 판단되는 부분이 어느 정도 TPS가 되야 전체 요구 TPS를 만족하는 지 계산 가능
요구 TPS 30, A TPS 60일 때 B TPS=
    목표 TPS / (1-(1/A TPS)) = 30/ (1-(1/60)) = 60

* 업무 서비스 요청 비율을 고려한 처리량 계산

```
* A 업무와 B 업무의 전체 처리량
= 1 / ((A 업무의 요청 비율 / A 업무의 최대 처리량) + (B 업무 요청 비율 / B 업무 최대 처리량) + ...)
```

A, B 두개 업무 시스템
A 업무는 개별 최대 20TPS 운영 시 초당 15개 요청 발생
B 업무는 개별 최대 200TPS에 운영 시 초당 5개 요청 발생
전체 초당 서비스 요청 : `20개`, A와 B 비율 : `0.75:0.25`

최대 TPS : 25.8TPS




